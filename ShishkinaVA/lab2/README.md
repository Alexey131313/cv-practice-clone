# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV.

## Описание структуры программы

Программа позволяет выполнять детектирование объектов на изображениях и видео. Она содержит класс YOLOv4Detector, а также дополнительные вспомогательные функции.

Атрибуты класса:

- `net: загруженная нейронная сеть.`
- `layersOutput: имена выходных слоев модели.`
- `classes: список имен классов.`
- `conf_threshold: порог уверенности для фильтрации детекций.`
- `nms_threshold: порог для подавления немаксимумов.`

Методы класса:

- `__init__(...) - инициализирует объект класса, загружая модель и классы.`
- `loadClasses(...) - загружает имена классов из файла.`
- `loadModel(...) - загружает модель YOLOv4.`
- `preprocessImage(...) - выполняет предобработку изображения.`
- `objectsDetection(...) - выполняет детектирование объектов на изображении.`
- `showResults(...) - отображает результаты детектирования нв изображении.`
- `readImage(...) - загружает изображение.`
- `writeImage(...) - cохраняет изображение в файл.`
- `showImage(...) - отображает изображение в окне.`
- `processVideo(...) - обрабатывает видео, выполняя детектирование объектов на каждом кадре.`

Вспомогательные функции: 

- `cli_argument_parser() - парсит аргументы командной строки.`
- `main() - основная функция программы.`

## Описание алгоритмов

### Функция для парсинга аргументов командной строки

- `-m`, `--mode`: режим работы (изображение или видео).
- `-i`, `--input`: путь к изображению или видео.
- `-o`, `--output`: путь до сохраненного выходного изображения или видео.
- `-d`, `--output_dir`: директория для сохранения кадров видео.
- `-c`, `--config`: путь к файлу конфигурации модели.
- `-w`, `--weights`: путь к файлу весов модели.
- `-cl`, `--classes`: путь к файлу с именами классов.
- `-ct`, `--conf_threshold`: порог уверенности.
- `-nt`, `--nms_threshold`: порог для подавления немаксимумов.

### Функция для загрузки (чтения) изображения

Данная функция  предназначена для загрузки, отображения изображения с использованием библиотеки OpenCV. 

- `Параметры функции: self - ссылка на экземпляр класса, к которому принадлежит метод; image_path - cтрока, содержащая путь к изображению, которое нужно загрузить.`
- `Функция cv2.imread(): используется для чтения изображения из указанного пути. Если изображение не может быть загружено, вызывается исключение.`
- `Проверка пути: если путь к изображению пустой (None), вызывается исключение ValueError с сообщением "Empty path to the image".`
- `Проверка загрузки изображения: если изображение не может быть загружено (None), вызывается исключение ValueError с сообщением "Unable to load image".`
- `Возвращаемое значение: загруженное изображение.`

### Функция для сохранения изображения

Данная функция  предназначена для сохранения изображения с использованием библиотеки OpenCV. 

- `Параметры функции: self - ссылка на экземпляр класса, к которому принадлежит метод; output_image - строка, содержащая путь к файлу, в который будет сохранено изображение.`
- `result_image: изображение, которое нужно сохранить.`
- `Функция cv2.imwrite(): используется для сохранения изображения в указанный файл. Если сохранение не удалось, выводится сообщение об ошибке.`
- `Проверка успешности сохранения: если сохранение не удалось (success равно False), выводится сообщение об ошибке с указанием пути к файлу.`

### Метод для загрузки классов

Метод загружает имена классов из текстового файла и возвращает их в виде списка. Этот метод используется для инициализации списка классов, которые могут быть детектированы моделью. Параметрами являютя ссылка на экземпляр класса, к которому принадлежит метод, строка, содержащая путь к файлу с именами классов. Метод возвращает список имен классов, загруженных из файла.

### Метод для загрузки модели

Метод загружает нейронную сеть YOLOv4, используя указанные пути к файлам весов и конфигурации. Он также определяет выходные слои сети, которые будут использоваться для получения результатов детектирования. Параметрами являются ссылка на экземпляр класса, к которому принадлежит метод, строка, содержащая путь к файлу весов модели, строка, содержащая путь к файлу конфигурации модели. Метод возвращает загруженную нейронную сеть и список имен выходных слоев.

### Метод предобработки изображения

Метод выполняет предварительную обработку изображения перед его подачей в нейронную сеть для детекции объектов. Он преобразует изображение в формат, подходящий для ввода в сеть, и устанавливает его в качестве входных данных для сети. Параметрами являются ссылка на экземпляр класса, к которому принадлежит метод, входное изображение, которое нужно предварительно обработать. Метод использует функцию cv2.dnn.blobFromImage() для преобразования изображения, а также setInput() для установки преобразованного изображения в качестве входных данных. Метод возвращает высоту, ширину и количество каналов исходного изображения.

### Метод детектирования объектов 

Метод выполняет детектирование объектов на изображении с использованием загруженной нейронной сети YOLOv4. Он обрабатывает выходные данные сети, фильтрует детекции по порогу уверенности, применяет подавление немаксимумов (NMS) и возвращает информацию о детектированных объектах. Параметрами являются ссылка на экземпляр класса, к которому принадлежит метод, высота исходного изображения, ширина исходного изображения, количество каналов исходного изображения, входное изображение, которое нужно обработать.

Метод выполняет прямое прохождение через нейронную сеть, используя метод forward(), и получает выходные данные для указанных выходных слоев.
Затем происходит извлечение наблюдений (observations) и классов объектов (classIds). Вычисляет уверенности (confidences) и фильтрует их по порогу уверенности.

Метод вычисляет координаты центров и размеры прямоугольников для каждого детектированного объекта. Преобразует координаты и размеры в целые числа.
Фильтрует детекции, уверенности которых превышают порог уверенности.

Метод применяет NMS для удаления перекрывающихся прямоугольников и оставляет только наиболее вероятные детекции. Создает словарь, содержащий количество детекций для каждого класса объектов.

Метод возвращает прямоугольники, уверенности, идентификаторы классов, индексы и словарь детектированных объектов.

### Метод отображения результатов детектирования на изображении

Метод отображает результаты детекции объектов на изображении. Он рисует прямоугольники вокруг детектированных объектов, добавляет метки с идентификаторами классов и уверенностями, а также отображает количество детекций для каждого класса объектов. Параметрами являются ссылка на экземпляр класса, к которому принадлежит метод, входное изображение, на котором будут отображены результаты детекции, прямоугольники, определяющие координаты и размеры детектированных объектов, уверенности детекций, идентификаторы классов детектированных объектов, индексы детекций после подавления немаксимумов, словарь, содержащий количество детекций для каждого класса объектов. Метод возвращает изображение с нанесенными результатами детекции.

### Метод, обрабатывающий видео

Метод обрабатывает видеофайл, выполняя детекцию объектов на каждом кадре. Он сохраняет каждый кадр с результатами детекции в указанную директорию и отображает кадры в окне. Параметрами являются ссылка на экземпляр класса, к которому принадлежит метод, строка, содержащая путь к видеофайлу, который нужно обработать, строка, содержащая путь к директории, в которую будут сохраняться кадры с результатами детекции. После завершения обработки видео метод закрывает видеофайл и все открытые окна с помощью функций cap.release() и cv2.destroyAllWindows().

### Главная функция программы

В этой функции происходит детектирование объектов на изображении или видео. Сначала необходимо задать параметры через командную строку, затем, в зависимости от выбранного режима, выполняются вызовы различных функций, описанных выше. Если режим не поддерживается, то программа выдаст ошибку, информируя о том, что такого режима не существует. 

